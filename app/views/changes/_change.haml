-#Locals: change

- taxon = change.reify
-# delete case
- if taxon.nil?
  -taxon = change.most_recent_valid_taxon

= render 'header', taxon: taxon, change: change

-unless taxon.taxon_state.nil?
  - css_class = taxon.approved? ? 'approved' : ''

%table.change{class: css_class}
  %tr
    %td
      %table

        %tr
          %td.label Name
          %td.value.name= format_taxon_name taxon.name

        %tr

          -#Special case - we ONLY see this if we ever modify family Formicidae
          -#taxon.name has a special case for family that return nil; I'm scared of breaking the universe
          -#if I change that behaviour.
          - if taxon.rank == 'family'
            %td.label.parent_rank= 'Order'
            %td.value.parent= 'Hymenoptera'
          - else
            %td.label.parent_rank= format_rank Rank[taxon.parent.rank]
            %td.value.parent= format_taxon_name taxon.parent.name

        %tr
          %td.label Status
          %td.value.status= format_status taxon.status

        - if taxon.incertae_sedis_in.present?
          %tr
            %td.label Incertae sedis in
            %td.value.incertae_sedis= taxon.incertae_sedis_in

        - attributes = format_attributes taxon
        - if attributes.present?
          %tr
            %td.label Attributes
            %td.value.attributes= attributes

        - if taxon.headline_notes_taxt.present?
          %tr
            %td.label Notes
            %td.value.notes= format_taxt taxon.headline_notes_taxt

      %table
        %tr
          - protonym = taxon.protonym
        - if protonym
          %td.header Protonym

          %tr
            %td.label Name
            %td.value.protonym_name= format_taxon_name protonym.name

          - attributes = format_protonym_attributes taxon
          - if attributes.present?
            %tr
              %td.label Attributes
              %td.value.protonym_attributes= attributes

          %tr
            - authorship = protonym.authorship
            %td.label Authorship
            %td.value.authorship_reference= format_reference authorship.reference

          %tr
            %td.label Page
            %td.value.page= authorship.pages

          %tr
            %td.label Forms
            %td.value.forms= authorship.forms

          %tr
            %td.label Locality
            %td.value.locality= protonym.locality

          - authorship_notes = authorship.notes_taxt
          - if authorship_notes.present?
            %tr
              %td.label Notes
              %td.value.authorship_notes= format_taxt authorship_notes

      - if taxon.type_name.present?
        %table
          %tr
            %td.header Type

          %tr
            %td.label Name
            %td.value.type_name= format_taxon_name taxon.type_name

          - attributes = format_type_attributes taxon
          - if attributes.present?
            %tr
              %td.label Attributes
              %td.value.type_attributes= attributes

          - if taxon.type_taxt.present?
            %tr
              %td.label Notes
              %td.value.type_notes= format_taxt taxon.type_taxt

      = render 'history_items', taxon: taxon

      = render 'reference_sections', taxon: taxon
