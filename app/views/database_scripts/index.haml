-title "Database Scripts"
-breadcrumb :database_scripts

-content_for :javascripts do
  =javascript_include_tag "sortable_tables"

-content_for :breadcrumbs_right do
  -unless @check_if_empty
    =link_to "Show empty/not (beta)", database_scripts_path(check_if_empty: 'yes'), class: "btn-normal"
  =link_to "Hide/show help", "#", data: { show_hide_toggler_for: "help" }, class: "btn-nodanger"

.row.margin-bottom{data: { show_hide_toggable_id: "help" }}
  .small-12.medium-9.columns.end
    .callout.primary
      %p
        =DatabaseScriptDecorator.format_tags [DatabaseScript::VALIDATED_TAG]
        means that there are validations in place to prevent the issue
      %p
        =DatabaseScriptDecorator.format_tags [DatabaseScript::HIGH_PRIORITY_TAG]
        is for issues we want to fix as soon as possible, usually because the issue is
        preventing us from improving the code
      %p
        =DatabaseScriptDecorator.format_tags [DatabaseScript::VERY_SLOW_TAG]
        may cause the site to become unresponsive

.row
  .small-12.columns
    -@grouped_database_scripts.each do |section, database_scripts|
      -case section
      -when DatabaseScript::REGRESSION_TEST_SECTION
        %h5 Regression tests
        %p
          For issues that have been mostly fixed, but we want to make sure do not re-appear
          =surround "(", ")." do
            =external_link_to "Regression testing", "https://en.wikipedia.org/wiki/Regression_testing"
          Only needs to be checked periodically.
      -when DatabaseScript::PENDING_AUTOMATION_ACTION_REQUIRED_SECTION
        %h5 Pending automation, editor action required
        %p
          For issues that require manual editing before they can be fixed by script.
          =link_to 'Open issues', issues_path
          or the scripts themselves may describe what needs to be done.
      -when DatabaseScript::PENDING_AUTOMATION_NO_ACTION_REQUIRED_SECTION
        %h5 Pending automation, no editor action required
        %p For issues that can be fixed by script once ageed upon, but require little to no manual editing.
      -when *DatabaseScript::SECTIONS
        %h5="#{section.capitalize} scripts"
      -else
        %h5 Unknown section. What???

      %table.tablesorter.huge-margin-bottom
        %thead
          %tr
            %th.no-wrap Category
            %th Script
            %th.no-wrap Tags
            %th Soft-validated
            %th Fix random
            -if @check_if_empty
              %th Empty?
        %tbody
          -database_scripts.each do |database_script|
            %tr
              %td.shrink=database_script.category
              %td
                =link_to database_script.title, database_script_path(database_script)
                -if database_script.issue_description.present?
                  %div
                    %small.gray-text
                      Issue description:
                      =database_script.issue_description
              %td=database_script.decorate.format_tags
              %td.shrink
                -if database_script.soft_validated?
                  %span.hidden-sort Yes
                  =antcat_icon("check")
              %td.shrink
                -if database_script.fix_random?
                  %span.hidden-sort Yes
                  =antcat_icon("check")
              -if @check_if_empty
                %td.shrink=database_script.decorate.empty_status
